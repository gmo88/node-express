<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetch</title>
</head>
<body>
<button onclick="fetchUsers()">GET /users</button>

<h3>Front-end: make fetch() to perform <i>GET /pages/{page_num}:</i></h3>
<label>Input number:<input type="number" class="inputField" min="0" max="20"></label><br>
<button class="button">GET /pages/{page_num}</button>
<div class="container"></div>

<h3>Find user</h3>
<label>Selected user:<input class="userNameInput" type="text"></label><br>
<button class="findUserBtn" onclick="getInputValue()">find</button>

<script>
    const getParams = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            "Access-Control-Allow-Origin": "*",
        }
    };

    let users = document.querySelector(".usersShow");
    let button = document.querySelector(".button");
    let currentPage = null;
    let data = null;

    button.addEventListener('click', () => openPage(document.querySelector(".inputField").value));

    const fetchUsers = () => {
        fetch('/users', getParams)
          .then(resp => resp.json())
          .then(jsonBody => {
              data = jsonBody;
              renderUserList(data, 'body');
          })
          .catch(error => renderUserList(error, 'body'));
    };

    const createButton = (type, value, where) => {
        let element = document.createElement("input");
        let whereToAppend = document.querySelector(where);
        element.setAttribute("type", type);
        element.setAttribute("value", value);
        element.onclick = function () {
            return fetchUsers();
        };
        whereToAppend.appendChild(element);
        return whereToAppend;
    };

    createButton('button', "get page number", 'body');

    const openPage = (page_num) => {
        fetch(`/pages/${page_num}`, getParams)
          .then(resp => resp.json())
          .then(jsonBody => jsonBody)
          .then(result => {
              currentPage = result;
              console.log('current page:', currentPage);
              generateDynamicTable(currentPage);
          })
          .catch(error => document.querySelector(".container").innerHTML = JSON.stringify(error));
    };

    const getInputValue = () => {
        let inputVal = document.querySelector('.userNameInput').value;
        const result = currentPage.users.filter(i => i.name.toLowerCase() === inputVal.toLowerCase());
        return renderUserList(result, "body");
    };

    const renderUserList = (data, where) => {
        let ul = document.createElement("ul");
        for (let i = 0; i < data.length; i++) {
            let li = document.createElement("li");
            let id = document.createTextNode(`id: ${data[i].id}, `);
            let name = document.createTextNode(`name: ${data[i].name}, `);
            let surname = document.createTextNode(`surname: ${data[i].surname} `);
            li.appendChild(id);
            li.appendChild(name);
            li.appendChild(surname);
            ul.appendChild(li);
        }
        document.querySelector(where).appendChild(ul);
    };

    function generateDynamicTable(result) {
        let table = document.createElement('table');
        let tHead = document.createElement("thead");
        let hRow = document.createElement("tr");
        let tBody = document.createElement("tbody");
        let container = document.querySelector('.container');
        let tableHeader = [];

        for (let i = 0; i < result.users.length; i++) {
            for (let key in result.users[i]) {
                if (tableHeader.indexOf(key) === -1) {
                    tableHeader.push(key);
                }
            }
        }

        for (let i = 0; i < tableHeader.length; i++) {
            let th = document.createElement("th");
            th.innerHTML = tableHeader[i];
            hRow.appendChild(th);
        }
        tHead.appendChild(hRow);
        table.appendChild(tHead);

        for (let i = 0; i < result.users.length; i++) {
            let tableRow = document.createElement("tr");
            for (let j = 0; j < tableHeader.length; j++) {
                let td = document.createElement("td");
                td.innerHTML = result.users[i][tableHeader[j]];
                tableRow.appendChild(td);
            }
            tBody.appendChild(tableRow);
        }
        table.appendChild(tBody);
        container.appendChild(table);
    }
</script>
</body>
</html>